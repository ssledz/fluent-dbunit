<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at Mar 27, 2013
 | Rendered using Apache Maven Fluido Skin 1.2.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fluent Db Unit - </title>
    <link rel="stylesheet" href="./css/apache-maven-fluido.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido.min.js"></script>

    
    <meta name="Date-Revision-yyyymmdd" content="20130327" />
    <meta http-equiv="Content-Language" content="en" />
    
        </head>
        <body class="topBarDisabled">
          
                        
                    
    
        <div class="container">
          <div id="banner">
        <div class="pull-left">
                                    <a href="https://github.com/ssledz/fluent-dbunit" id="bannerLeft">
                                                                                                <img src="images/fluent-db-unit-banner.jpg"  alt="A Fluent Db Unit Site"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
            
                  <li id="publishDate">Last Published: 2013-03-27</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 1.3-SNAPSHOT</li>
                      
                
            
      
                                  
    <li class="pull-right">              <a href="http://sof-tech.pl" class="externalLink" title="sof-tech">sof-tech</a>
  </li>

                        </ul>
      </div>

      
        <div id="bodyColumn" >
                                  
            <h2>Building from sources</h2>

<pre><code>git clone https://github.com/ssledz/fluent-dbunit.git
cd cd fluent-dbunit
mvn package
</code></pre>

<h2>Dependencies</h2>

<pre><code>&lt;repositories&gt;
    &lt;repository&gt;
        &lt;id&gt;mvn.repo&lt;/id&gt;
        &lt;url&gt;https://github.com/ssledz/mvn-repo/raw/master&lt;/url&gt;
    &lt;/repository&gt;
&lt;/repositories&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;pl.softech&lt;/groupId&gt;
        &lt;artifactId&gt;fluent-dbunit&lt;/artifactId&gt;
        &lt;version&gt;1.2&lt;/version&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>

<h2>Let's test some code :)</h2>

<p>Assume that You have to test java class <a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/main/java/pl/softech/fluent/dbunit/usecase/dao/BookstoreDao.java">BookstoreDao</a>,
which implements following interface</p>

<pre><code>public interface IBookstoreDao {

    List&lt;Author&gt; fetchAuthorsByName(String name) throws SQLException;
    void save(Author author) throws SQLException;
    List&lt;Book&gt; fetchBooksByAuthor(Author author) throws SQLException;

}
</code></pre>

<p>Let's write the test for <a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/test/java/pl/softech/fluent/dbunit/usecase/dao/BookstoreDaoTest.java">fetchAuthorsByName</a></p>

<pre><code>@Test
public void testFetchAuthorsByName() throws Exception {

    //loads data to author's table 
    DBLoader.forDB(ds).cleanInsert(dataSet(table("author", //
            cols("id", "name", "lastname"), //
            row("1", "Orson", "Card"), //
            row("2", "Terry", "Pratchett"), //
            row("3", "Magdalena", "Kozak"), //
            row("4", "Miroslav", "Žamboch"), //
            row("5", "Terry", "Goodkind") //
            )));

    BookstoreDao dao = new BookstoreDao(ds);
    Iterator&lt;Author&gt; it = dao.fetchAuthorsByName("Terry").iterator();
    Assert.assertEquals("Pratchett", it.next().getLastname());
    Assert.assertEquals("Goodkind", it.next().getLastname());

}
</code></pre>

<p>As You see filling a table with data is extremely easy. You can achieve this by
writing simple one liner :)</p>

<p>If You don't like to manage data in your source code you can store them either in csv or xml file</p>

<pre><code>@Test
public void testFetchAuthorsByName2() throws Exception {
    String dbxml = BookstoreDaoTest.class.getResource("db.xml").getFile();

    //loades data from file to memory
    IDataSet dataSet = DBLoader.fromXml(dbxml);

    //loads data to tables
    DBLoader.forDB(ds).cleanInsert(dataSet);

    //prints tables in dataset
    System.out.println(DBUtils.dataSet2String(dataSet));

    BookstoreDao dao = new BookstoreDao(ds);
    Iterator&lt;Author&gt; it = dao.fetchAuthorsByName("Terry").iterator();
    Assert.assertEquals("Pratchett", it.next().getLastname());
}
</code></pre>

<p><a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/test/resources/pl/softech/fluent/dbunit/usecase/dao/db.xml">db.xml</a> could look like</p>

<pre><code>&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;dataset&gt;
  &lt;author ID="1" NAME="Orson" LASTNAME="Card"/&gt;
  &lt;author ID="2" NAME="Terry" LASTNAME="Pratchett"/&gt;
  &lt;author ID="3" NAME="Magdalena" LASTNAME="Kozak"/&gt;
  &lt;author ID="4" NAME="Miroslav" LASTNAME="&amp;#381;amboch"/&gt;
  &lt;author ID="5" NAME="Terry" LASTNAME="Goodkind"/&gt;
  &lt;book ID="1" TITLE="Ender&amp;apos;s Game" AUTHOR_ID="5"/&gt;
&lt;/dataset&gt;
</code></pre>

<p>Next method to test is 'save' which creates or updates records in db</p>

<pre><code>@Test
public void testSaveAuthor() throws Exception {

    //loads data to author's table 
    DBLoader.forDB(ds).cleanInsert(dataSet(table("author", //
            cols("id", "name", "lastname"), //
            row("5", "Orson", "Card") //
            )));

    BookstoreDao dao = new BookstoreDao(ds);
    Author[] authors = {
        new Author(-1, "Terry", "Pratchett"),
        new Author(5, "Orson Scott", "Card")
    };

    for (Author author : authors) {
        dao.save(author);
    }

    //compares two tables
    DBLoader.forDB(ds).assertQueryTable(table("author", //
            cols("name", "lastname"), //
            row("Orson Scott", "Card"), //
            row("Terry", "Pratchett")), //
            "SELECT name, lastname FROM author", "name");

}
</code></pre>

<p>This example shows how can You perform simple check of whether or not data satisfy assumed postconditions </p>

<p>The last example, the most complex</p>

<pre><code>@Test
public void testFetchBooksByAuthor() throws Exception {

    //loads data to author's table 
    DBLoader.forDB(ds).cleanInsert(dataSet(table("author", //
            cols("id", "name", "lastname"), //
            row("5", "Orson", "Card") //
            )));
    //loads data to book's table 
    DBLoader.forDB(ds).cleanInsert(dataSet(table("book", //
            cols("id", "title", "author_id"), //
            row("1", "Ender's Game", "5") //
            )));

    //fetches whole author's table to memory
    ITable authorTable = DBExporter.forDB(ds).table("author").getDataSet().getTable("author");

    //prints table to system out
    System.out.println(DBUtils.dataSet2String(authorTable));

    //transforms whole author's table to collection of entities
    Collection&lt;Author&gt; authors = DBUtils.table2Entity(authorTable, new DBUtils.IEntityFactory&lt;Author&gt;() {
        public Collection&lt;Author&gt; create(DBUtils.ITableResultSet rset) {
            Collection&lt;Author&gt; authors = new LinkedList&lt;Author&gt;();
            while (rset.next()) {
                authors.add(new Author(rset.getInteger("id"), rset.getString("name"), rset.getString("lastname")));
            }
            return authors;
        }
    });

    BookstoreDao dao = new BookstoreDao(ds);
    List&lt;Book&gt; books = dao.fetchBooksByAuthor(authors.iterator().next());
    Assert.assertEquals("Ender's Game", books.get(0).getTitle());

}
</code></pre>

<h2>Exporting data</h2>

<p>Assume that You are facing with problem of creating data to Your test cases. 
Often such data can be fetched from your production or testing db. You can do this
in the following manner (<a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/main/java/pl/softech/fluent/dbunit/usecase/export/ExportUseCases.java">ExportUseCases</a>)</p>

<pre><code>//fetches table of author and book
DBExporter.MyDataSet dataSet = DBExporter.forDB(ds).table("author", "book");
File dir = new File(ExportUseCases.class.getClassLoader().getResource(".").getFile()).getParentFile();
//saves tables in the db-csv directory
dataSet.write2Csv(new File(dir, "db-csv").getAbsolutePath());
//saves tables in the db.xml file
dataSet.write2Xml(new File(dir, "db.xml").getAbsolutePath());
</code></pre>

<p>Content of the db-csv directory is following</p>

<pre><code>ssledz@echo:~/git/fluent-dbunit-usecase/target/db-csv$ ls
author.csv  book.csv  table-ordering.txt

ssledz@echo:~/git/fluent-dbunit-usecase/target/db-csv$ cat table-ordering.txt 
author
book

ssledz@echo:~/git/fluent-dbunit-usecase/target/db-csv$ cat author.csv 
ID, NAME, LASTNAME
"1","Orson","Card"
"2","Terry","Pratchett"
"3","Magdalena","Kozak"
"4","Miroslav","Žamboch"
"5","Terry","Goodkind"

ssledz@echo:~/git/fluent-dbunit-usecase/target/db-csv$ cat book.csv 
ID, TITLE, AUTHOR_ID
"1","Ender's Game","5"
</code></pre>

<h2>Resources</h2>

<ul>
<li><a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/main/java/pl/softech/fluent/dbunit/usecase/dao/BookstoreDao.java">BookstoreDao.java</a></li>
<li><a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/main/java/pl/softech/fluent/dbunit/usecase/model/Author.java">Author.java</a></li>
<li><a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/main/java/pl/softech/fluent/dbunit/usecase/model/Book.java">Book.java</a></li>
<li><a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/main/java/pl/softech/fluent/dbunit/usecase/export/ExportUseCases.java">ExportUseCases.java</a></li>
<li><a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/test/java/pl/softech/fluent/dbunit/usecase/dao/BookstoreDaoTest.java">BookstoreDaoTest.java</a></li>
<li><a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/test/resources/pl/softech/fluent/dbunit/usecase/dao/db.xml">db.xml</a></li>
<li><a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/test/resources/pl/softech/fluent/dbunit/usecase/dao/db-csv/author.csv">author.csv</a></li>
<li><a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/test/resources/pl/softech/fluent/dbunit/usecase/dao/db-csv/book.csv">book.csv</a></li>
<li><a href="https://github.com/ssledz/fluent-dbunit-usecase/blob/master/src/test/resources/pl/softech/fluent/dbunit/usecase/dao/db-csv/table-ordering.txt">table-ordering.txt</a></li>
</ul>

                  </div>
      
    <hr/>

    <footer>
            <div class="container">
              <div class="row span16">Copyright &copy;                   2013.
          All Rights Reserved.      
            
      </div>

        
                <p id="poweredBy" class="pull-right">
                                                                                                                      <a href="http://sof-tech.pl" title="sof-tech" class="poweredBy">
        <img class="poweredBy"  alt="sof-tech" src="images/sof-tech-banner.jpg"    />
      </a>
                  </p>
        
                </div>
    </footer>
  </body>
</html>
